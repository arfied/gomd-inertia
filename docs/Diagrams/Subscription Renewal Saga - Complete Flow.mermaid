graph TD
    A["ðŸ‘¤ User Clicks Renew Button"] --> B["ðŸ“± PatientSubscriptionController::renew()"]
    B --> C["âœ… Validate Subscription Exists"]
    C --> D["ðŸ”„ Create SubscriptionRenewalSaga"]
    D --> E["ðŸ“ Record SubscriptionRenewalSagaStarted Event"]
    E --> F["ðŸ’¾ Store Event in Event Store"]
    F --> G["ðŸ“¢ Dispatch Event to Listeners"]

    G --> H["ðŸ‘‚ SubscriptionRenewalSagaStartedListener"]
    H --> I["ðŸ“¤ Dispatch ProcessSubscriptionRenewalJob"]
    I --> J["â³ Job Queued on subscription-renewal Queue"]

    J --> K["â–¶ï¸ Job Executes"]
    K --> L["ðŸ” Get Subscription & User"]
    L --> M["ðŸ’³ Get Default Payment Method"]

    M --> N{Payment Method Found?}
    N -->|No| O["âŒ Record Payment Failure"]
    N -->|Yes| P{Payment Type?}

    P -->|Credit Card| Q["ðŸ’° Process Credit Card via AuthorizeNet"]
    P -->|ACH| R["ðŸ¦ Process ACH via AchPaymentService"]

    Q --> S{Payment Success?}
    R --> S

    S -->|Success| T["âœ… Record Payment Success"]
    S -->|Failure| O

    T --> U["ðŸŽ‰ Create SubscriptionRenewalSagaCompleted Event"]
    O --> V["âš ï¸ Create SubscriptionRenewalSagaFailed Event"]

    U --> W["ðŸ’¾ Store Completion Event"]
    V --> X["ðŸ’¾ Store Failure Event"]

    W --> Y["ðŸ“¢ Dispatch Completion Event"]
    X --> Z["ðŸ“¢ Dispatch Failure Event"]

    Y --> AA["âœ… Subscription Status: ACTIVE"]
    Y --> AB["ðŸ“Š Analytics Handler Updates Metrics"]

    Z --> AC["âŒ Subscription Status: CANCELLED"]
    Z --> AD["ðŸ“Š Analytics Handler Logs Failure"]

    AA --> AE["âœ¨ Renewal Complete"]
    AC --> AF["ðŸ”„ Retry or Manual Intervention"]

    style A fill:#e1f5ff
    style B fill:#e1f5ff
    style H fill:#fff3e0
    style K fill:#fff3e0
    style T fill:#c8e6c9
    style O fill:#ffcdd2
    style AA fill:#c8e6c9
    style AC fill:#ffcdd2
    style AE fill:#c8e6c9
    style AF fill:#ffcdd2
